# NPC æ€ç»´ç³»ç»Ÿæµ‹è¯•æ¡†æ¶é—®é¢˜æŠ¥å‘Š

> **æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
> **åˆ›å»ºæ—¥æœŸ**: 2025-11-24  
> **é¡¹ç›®**: Guzhenren-ext CustomNPCs  
> **ç›®æ ‡**: æ„å»ºå¥å£®ã€åŠŸèƒ½æ€§å¼ºçš„NPCæ€ç»´ç³»ç»Ÿæµ‹è¯•æ¡†æ¶

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

å½“å‰é¡¹ç›®ä½¿ç”¨Minecraft GameTestæ¡†æ¶è¿›è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•ã€‚è™½ç„¶åŸºç¡€åŠŸèƒ½å¯ç”¨ï¼Œä½†åœ¨å¤æ‚åœºæ™¯æµ‹è¯•ä¸­æš´éœ²å‡ºå¤šä¸ªå±€é™æ€§ã€‚æœ¬æŠ¥å‘Šåˆ†æç°æœ‰é—®é¢˜ï¼Œå¹¶æå‡ºæœªæ¥å¯èƒ½éœ€è¦çš„æµ‹è¯•èƒ½åŠ›ã€‚

**å…³é”®å‘ç°**ï¼š
- âœ… GameTesté€‚åˆç®€å•åŠŸèƒ½æµ‹è¯•
- âš ï¸ å¤æ‚åœºæ™¯æµ‹è¯•å—é™äºæ¡†æ¶çº¦æŸ
- ğŸ”´ ç¼ºä¹å¼‚æ­¥è¡Œä¸ºå’Œé•¿æœŸä»»åŠ¡çš„æµ‹è¯•æ”¯æŒ
- ğŸ”´ ç¼ºä¹æ€§èƒ½ç›‘æ§å’Œå¯è§†åŒ–èƒ½åŠ›
- ğŸ”´ ç¼ºä¹AIè¡Œä¸ºçš„å¯å¤ç°æ€§ä¿è¯

---

## ğŸ”´ ç¬¬ä¸€éƒ¨åˆ†ï¼šç°æœ‰é—®é¢˜åˆ†æ

### 1.1 GameTest æ¡†æ¶ç»“æ„æ€§é—®é¢˜

#### é—®é¢˜ A1: Final Clause å†²çª
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜  
**å½±å“èŒƒå›´**: æ‰€æœ‰å¤æ‚åœºæ™¯æµ‹è¯•

**é—®é¢˜æè¿°**ï¼š
GameTestæ¡†æ¶ä¸å…è®¸ä¸€ä¸ªæµ‹è¯•æœ‰å¤šä¸ª"æœ€ç»ˆåˆ¤æ–­å­å¥"ï¼ˆfinal clauseï¼‰ã€‚ä»¥ä¸‹ç»„åˆä¼šå¯¼è‡´é”™è¯¯ï¼š
```java
helper.succeedWhen(() -> { /* æ¡ä»¶1 */ });
helper.succeedOnTickWhen(100, () -> { /* æ¡ä»¶2 */ });
```

**å½“å‰å½±å“**ï¼š
- `testTheGatherer` - å¤±è´¥
- `testTheCourier` - å¤±è´¥

**æ ¹æœ¬åŸå› **ï¼š
GameTestè®¾è®¡ä¸ºå•ä¸€æˆåŠŸè·¯å¾„ï¼Œä¸æ”¯æŒå¤šä¸ªæˆåŠŸé€€å‡ºæ¡ä»¶ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- **çŸ­æœŸ**ï¼šé‡æ„ä¸ºå•ä¸€`succeedWhen()`ï¼Œå†…éƒ¨ä½¿ç”¨tickè®¡æ•°å™¨
- **é•¿æœŸ**ï¼šéœ€è¦è‡ªå®šä¹‰æµ‹è¯•æ¡†æ¶æ”¯æŒå¤šæ¡ä»¶æˆåŠŸåˆ¤æ–­

---

#### é—®é¢˜ A2: Tick æ—¶åºæ§åˆ¶ä¸ç²¾ç¡®
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­  
**å½±å“èŒƒå›´**: æ€§èƒ½æµ‹è¯•ã€æ—¶åºæ•æ„Ÿæµ‹è¯•

**é—®é¢˜æè¿°**ï¼š
```java
helper.succeedOnTickWhen(25, () -> {
    // æœŸæœ›åœ¨ tick 25 æ‰§è¡Œï¼Œä½†å®é™…åœ¨ tick 0 å°±æ‰§è¡Œäº†
});
```

**å½“å‰å½±å“**ï¼š
- `testPerformanceStress` - tickè®¡æ•°å¼‚å¸¸

**æ ¹æœ¬åŸå› **ï¼š
- GameTestçš„tickè®¡æ•°å¯èƒ½åœ¨æµ‹è¯•åˆå§‹åŒ–æ—¶å°±è§¦å‘
- ç¼ºä¹æ˜ç¡®çš„"æµ‹è¯•å¼€å§‹"å’Œ"æµ‹è¯•è¿è¡Œä¸­"çš„ç”Ÿå‘½å‘¨æœŸé’©å­

**è§£å†³æ–¹æ¡ˆ**ï¼š
- **çŸ­æœŸ**ï¼šä½¿ç”¨`helper.onEachTick()`æ‰‹åŠ¨è®¡æ•°
- **é•¿æœŸ**ï¼šéœ€è¦æ˜ç¡®çš„æµ‹è¯•ç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨

---

#### é—®é¢˜ A3: å®ä½“ Capability/Attachment åˆå§‹åŒ–ä¸ä¸€è‡´
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­  
**å½±å“èŒƒå›´**: æ‰€æœ‰ä¾èµ–NpcMindçš„æµ‹è¯•

**é—®é¢˜æè¿°**ï¼š
æµ‹è¯•ä¸­ç”Ÿæˆçš„å®ä½“ï¼ˆå¦‚Zombieï¼‰é»˜è®¤ä¸é™„åŠ `NpcMind` attachmentï¼Œéœ€è¦æ‰‹åŠ¨æ£€æŸ¥å’Œåˆ›å»ºï¼š
```java
if (zombie.hasData(NpcMindAttachment.NPC_MIND)) {
    // å¯èƒ½ä¸ºç©ºï¼
}
```

**æ ¹æœ¬åŸå› **ï¼š
- GameTestç¯å¢ƒä¸æ­£å¸¸æ¸¸æˆç¯å¢ƒä¸åŒ
- `NpcMindInitializer`çš„`EntityJoinLevelEvent`å¯èƒ½ä¸è§¦å‘

**è§£å†³æ–¹æ¡ˆ**ï¼š
- **çŸ­æœŸ**ï¼šæµ‹è¯•ä¸­æ˜¾å¼åˆ›å»ºå¹¶é™„åŠ 
- **é•¿æœŸ**ï¼šéœ€è¦æµ‹è¯•ç¯å¢ƒçš„ç»Ÿä¸€åˆå§‹åŒ–å™¨

---

### 1.2 æµ‹è¯•èƒ½åŠ›ç¼ºå¤±

#### é—®é¢˜ B1: ç¼ºä¹å¼‚æ­¥ä»»åŠ¡æµ‹è¯•æ”¯æŒ
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜  
**æœªæ¥å½±å“**: AIè§„åˆ’ã€é•¿æœŸç›®æ ‡ã€å¤šæ­¥éª¤ä»»åŠ¡

**é—®é¢˜æè¿°**ï¼š
å½“å‰æµ‹è¯•æ˜¯åŒæ­¥çš„ï¼Œæ— æ³•æœ‰æ•ˆæµ‹è¯•ï¼š
- GOAPè§„åˆ’å™¨çš„å¼‚æ­¥ç”Ÿæˆè®¡åˆ’
- å¤šæ­¥éª¤åŠ¨ä½œåºåˆ—çš„æ‰§è¡Œ
- NPCé•¿æœŸè¡Œä¸ºï¼ˆå¦‚"å»ºé€ æˆ¿å±‹"éœ€è¦æ•°ç™¾ä¸ªtickï¼‰

**å½“å‰ç¼ºå¤±**ï¼š
```java
// æœŸæœ›çš„APIï¼ˆä¸å­˜åœ¨ï¼‰ï¼š
testHelper.waitForCondition(
    () -> npc.getCurrentGoal().getName().equals("build_house"),
    timeout: 500 ticks,
    onTimeout: () -> fail("Goal not started")
);
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
éœ€è¦è‡ªå®šä¹‰çš„å¼‚æ­¥æµ‹è¯•æ¡†æ¶ï¼Œæ”¯æŒï¼š
- æ¡ä»¶ç­‰å¾…ï¼ˆwait-forï¼‰
- è¶…æ—¶å¤„ç†
- ä¸­é—´çŠ¶æ€éªŒè¯

---

#### é—®é¢˜ B2: ç¼ºä¹è¡Œä¸ºå¯å¤ç°æ€§ä¿è¯
**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ é«˜  
**æœªæ¥å½±å“**: æ‰€æœ‰AIå†³ç­–æµ‹è¯•

**é—®é¢˜æè¿°**ï¼š
AIç³»ç»Ÿï¼ˆUtility AI + GOAPï¼‰åŒ…å«æ¦‚ç‡æ€§å’Œä¼˜å…ˆçº§è®¡ç®—ï¼ŒåŒä¸€æµ‹è¯•å¯èƒ½äº§ç”Ÿä¸åŒç»“æœã€‚

**ä¾‹å¦‚**ï¼š
```java
// åŒæ ·çš„åˆå§‹çŠ¶æ€ï¼ŒNPCå¯èƒ½é€‰æ‹©ä¸åŒçš„ç›®æ ‡
// - æœ‰æ—¶é€‰æ‹© "gather_food" (ä¼˜å…ˆçº§ 0.85)
// - æœ‰æ—¶é€‰æ‹© "explore" (ä¼˜å…ˆçº§ 0.82)
```

**å½“å‰ç¼ºå¤±**ï¼š
- éšæœºç§å­æ§åˆ¶
- ç¡®å®šæ€§ä¼˜å…ˆçº§è®¡ç®—æ¨¡å¼
- è¡Œä¸ºå½•åˆ¶ä¸å›æ”¾

**è§£å†³æ–¹æ¡ˆ**ï¼š
éœ€è¦"æµ‹è¯•æ¨¡å¼"ï¼š
- å›ºå®šéšæœºç§å­
- ç¦ç”¨æ—¶é—´ç›¸å…³çš„ä¼˜å…ˆçº§æ³¢åŠ¨
- å½•åˆ¶å†³ç­–è¿‡ç¨‹ç”¨äºè°ƒè¯•

---

#### é—®é¢˜ B3: ç¼ºä¹æ€§èƒ½ç›‘æ§å’ŒProfileèƒ½åŠ›
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­  
**æœªæ¥å½±å“**: æ€§èƒ½ä¼˜åŒ–ã€ç“¶é¢ˆåˆ†æ

**é—®é¢˜æè¿°**ï¼š
è™½ç„¶`testPerformanceStress`èƒ½æµ‹é‡æ€»è€—æ—¶ï¼Œä½†ç¼ºä¹ç»†ç²’åº¦åˆ†æï¼š
- æ— æ³•è¯†åˆ«å“ªä¸ªä¼ æ„Ÿå™¨æœ€æ…¢
- æ— æ³•Profile GOAPè§„åˆ’å™¨çš„æœç´¢è¿‡ç¨‹
- æ— æ³•å¯è§†åŒ–æ€§èƒ½çƒ­ç‚¹

**å½“å‰èƒ½åŠ›**ï¼š
```java
// åªèƒ½æµ‹é‡æ€»æ—¶é—´
long totalTime = tickEnd - tickStart;
```

**æœŸæœ›èƒ½åŠ›**ï¼š
```java
// æœŸæœ›çš„API
ProfilerSession session = testHelper.startProfiler();
npc.tick();
ProfileReport report = session.stop();
// report.getSensorTimes(), report.getPlanningSteps(), etc.
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
éœ€è¦é›†æˆProfilerï¼š
- æ¯ä¸ªæ¨¡å—çš„è€—æ—¶ç»Ÿè®¡
- è°ƒç”¨æ ˆåˆ†æ
- æ€§èƒ½æŠ¥å‘Šç”Ÿæˆ

---

#### é—®é¢˜ B4: ç¼ºä¹AIå†³ç­–è¿‡ç¨‹çš„å¯è§‚æµ‹æ€§
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­  
**æœªæ¥å½±å“**: è°ƒè¯•å¤æ‚AIè¡Œä¸º

**é—®é¢˜æè¿°**ï¼š
å½“æµ‹è¯•å¤±è´¥æ—¶ï¼Œå¾ˆéš¾ç†è§£"ä¸ºä»€ä¹ˆNPCåšäº†è¿™ä¸ªå†³å®š"ï¼š
- ä¸ºä»€ä¹ˆé€‰æ‹©äº†è¿™ä¸ªç›®æ ‡ï¼Ÿ
- ä¸ºä»€ä¹ˆè§„åˆ’ç”Ÿæˆäº†è¿™ä¸ªåŠ¨ä½œåºåˆ—ï¼Ÿ
- å“ªä¸ªä¼ æ„Ÿå™¨æä¾›äº†å…³é”®ä¿¡æ¯ï¼Ÿ

**å½“å‰èƒ½åŠ›**ï¼š
åªèƒ½é€šè¿‡æ•£å¸ƒçš„`System.out.println`æŸ¥çœ‹æ—¥å¿—

**æœŸæœ›èƒ½åŠ›**ï¼š
```java
// æœŸæœ›çš„API
DecisionTrace trace = testHelper.recordDecisions(npc);
npc.tick();
// trace.getGoalEvaluations()
// trace.getSelectedGoal()
// trace.getPlanningInputs()
// trace.getPlanningOutput()
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
éœ€è¦å†³ç­–è¿½è¸ªç³»ç»Ÿï¼š
- è®°å½•æ¯ä¸ªå†³ç­–ç‚¹çš„è¾“å…¥è¾“å‡º
- ç”Ÿæˆå¯è§†åŒ–å†³ç­–æ ‘
- æ”¯æŒæ—¶é—´æ—…è¡Œè°ƒè¯•

---

### 1.3 æµ‹è¯•æ•°æ®ç®¡ç†é—®é¢˜

#### é—®é¢˜ C1: æµ‹è¯•ç»“æ„æ–‡ä»¶ç®¡ç†æ··ä¹±
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­  
**å½±å“èŒƒå›´**: æ‰€æœ‰éœ€è¦ç‰¹å®šç¯å¢ƒçš„æµ‹è¯•

**é—®é¢˜æè¿°**ï¼š
å½“å‰éœ€è¦æ‰‹åŠ¨åˆ›å»º`.nbt`ç»“æ„æ–‡ä»¶ï¼š
```
structure/
â”œâ”€â”€ complexscenarios.empty.nbt
â”œâ”€â”€ complexscenarios.testthegatherer.nbt
â”œâ”€â”€ complexscenarios.testthecourier.nbt
â””â”€â”€ complexscenarios.testperformancestress.nbt
```

**é—®é¢˜**ï¼š
- ç»“æ„æ–‡ä»¶æ˜¯äºŒè¿›åˆ¶ï¼Œéš¾ä»¥ç‰ˆæœ¬æ§åˆ¶
- å‘½åçº¦å®šå®¹æ˜“å‡ºé”™ï¼ˆ`classname.templatename.nbt`ï¼‰
- ä¿®æ”¹ç»“æ„éœ€è¦è¿›å…¥æ¸¸æˆæ‰‹åŠ¨ç¼–è¾‘

**è§£å†³æ–¹æ¡ˆ**ï¼š
- **çŸ­æœŸ**ï¼šä½¿ç”¨`.snbt`ï¼ˆæ–‡æœ¬æ ¼å¼ï¼‰ä»£æ›¿`.nbt`
- **é•¿æœŸ**ï¼šç¨‹åºåŒ–ç”Ÿæˆæµ‹è¯•ç¯å¢ƒ

---

#### é—®é¢˜ C2: ç¼ºä¹æµ‹è¯•æ•°æ®éš”ç¦»
**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ ä¸­  
**å½±å“èŒƒå›´**: å¤šä¸ªæµ‹è¯•å¯èƒ½äº’ç›¸å½±å“

**é—®é¢˜æè¿°**ï¼š
å¦‚æœæµ‹è¯•ä¿®æ”¹äº†å…¨å±€çŠ¶æ€ï¼ˆå¦‚ä¸–ç•Œæ•°æ®ã€é…ç½®ï¼‰ï¼Œå¯èƒ½å½±å“åç»­æµ‹è¯•ã€‚

**å½“å‰ç¼ºå¤±**ï¼š
- æµ‹è¯•é—´çš„çŠ¶æ€éš”ç¦»
- è‡ªåŠ¨å›æ»šæœºåˆ¶
- æ²™ç›’ç¯å¢ƒ

**è§£å†³æ–¹æ¡ˆ**ï¼š
éœ€è¦æµ‹è¯•éš”ç¦»æ¡†æ¶ï¼š
- æ¯ä¸ªæµ‹è¯•ç‹¬ç«‹çš„ä¸–ç•Œå®ä¾‹
- é…ç½®å¿«ç…§ä¸æ¢å¤
- å†…å­˜æ•°æ®åº“

---

## ğŸ”® ç¬¬äºŒéƒ¨åˆ†ï¼šæœªæ¥éœ€æ±‚é¢„ä¼°

### 2.1 å¤æ‚åœºæ™¯æµ‹è¯•éœ€æ±‚

#### éœ€æ±‚ F1: å¤šNPCåä½œæµ‹è¯•
**ä¼˜å…ˆçº§**: ğŸ”´ é«˜  
**é¢„è®¡éœ€è¦æ—¶é—´**: 3-6ä¸ªæœˆ

**åœºæ™¯æè¿°**ï¼š
æµ‹è¯•å¤šä¸ªNPCçš„åä½œè¡Œä¸ºï¼Œä¾‹å¦‚ï¼š
- æ‘æ°‘Aç æ ‘ï¼Œæ‘æ°‘Bæ”¶é›†æœ¨å¤´ï¼Œæ‘æ°‘Cå»ºé€ æˆ¿å±‹
- å®ˆå«Aå’Œå®ˆå«Bè½®æµå·¡é€»

**å½“å‰ç¼ºå¤±**ï¼š
- å¤šå®ä½“çš„åŒæ­¥ç®¡ç†
- åä½œç›®æ ‡çš„å®šä¹‰
- å†²çªæ£€æµ‹ï¼ˆä¸¤ä¸ªNPCæŠ¢åŒä¸€èµ„æºï¼‰

**æœŸæœ›çš„æµ‹è¯•API**ï¼š
```java
@GameTest
void testCooperation(GameTestHelper helper) {
    NPC lumberjack = helper.spawnNPC(EntityType.VILLAGER, pos1);
    NPC builder = helper.spawnNPC(EntityType.VILLAGER, pos2);
    
    // è®¾ç½®åä½œç›®æ ‡
    lumberjack.setGoal(new ChopTreeGoal());
    builder.setGoal(new BuildHouseGoal());
    
    // éªŒè¯åä½œæµç¨‹
    helper.waitUntil(() -> 
        lumberjack.hasCollectedWood() && builder.hasStartedBuilding()
    );
}
```

**å®ç°å»ºè®®**ï¼š
- NPCé€šä¿¡åè®®
- å…±äº«ä»»åŠ¡æ¿
- èµ„æºé”å®šæœºåˆ¶

---

#### éœ€æ±‚ F2: åŠ¨æ€ç¯å¢ƒå˜åŒ–æµ‹è¯•
**ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­  
**é¢„è®¡éœ€è¦æ—¶é—´**: 2-4ä¸ªæœˆ

**åœºæ™¯æè¿°**ï¼š
æµ‹è¯•NPCå¯¹ç¯å¢ƒå˜åŒ–çš„ååº”ï¼š
- æ ‘æœ¨è¢«ç å€’
- æ€ªç‰©å‡ºç°
- å¤©æ°”/æ—¶é—´å˜åŒ–

**æœŸæœ›çš„æµ‹è¯•API**ï¼š
```java
@GameTest
void testEnvironmentChange(GameTestHelper helper) {
    NPC npc = helper.spawnNPC(...);
    
    // åˆå§‹ï¼šNPCåœ¨é—²é€›
    helper.assertGoal(npc, IdleGoal.class);
    
    // ç¯å¢ƒå˜åŒ–ï¼šç”Ÿæˆæ€ªç‰©
    Zombie zombie = helper.spawn(EntityType.ZOMBIE, nearNpc);
    
    // éªŒè¯ï¼šNPCåˆ‡æ¢åˆ°é€ƒè·‘ç›®æ ‡
    helper.waitForGoalChange(npc, FleeGoal.class, timeout: 50);
}
```

**å®ç°å»ºè®®**ï¼š
- ç¯å¢ƒäº‹ä»¶æ¨¡æ‹Ÿå™¨
- æ„ŸçŸ¥ç³»ç»Ÿçš„è§¦å‘æµ‹è¯•
- ç›®æ ‡åˆ‡æ¢éªŒè¯

---

#### éœ€æ±‚ F3: å­¦ä¹ ä¸è®°å¿†æµ‹è¯•
**ä¼˜å…ˆçº§**: ğŸŸ¢ ä½  
**é¢„è®¡éœ€è¦æ—¶é—´**: 6-12ä¸ªæœˆ

**åœºæ™¯æè¿°**ï¼š
å¦‚æœæœªæ¥NPCæ”¯æŒå­¦ä¹ ï¼ˆå¦‚å¼ºåŒ–å­¦ä¹ ï¼‰ï¼Œéœ€è¦æµ‹è¯•ï¼š
- NPCä»å¤±è´¥ä¸­å­¦ä¹ 
- è®°å¿†ç³»ç»Ÿçš„é•¿æœŸä¿å­˜
- è¡Œä¸ºæ¨¡å¼çš„ä¼˜åŒ–

**æœŸæœ›çš„æµ‹è¯•API**ï¼š
```java
@GameTest
void testLearning(GameTestHelper helper) {
    NPC npc = helper.spawnNPC(...);
    
    // ç¬¬ä¸€æ¬¡å°è¯•ï¼šå¤±è´¥
    npc.attemptTask(new ComplexTask());
    helper.assertTaskResult(TaskResult.FAILED);
    
    // å­¦ä¹ åï¼šæˆåŠŸ
    helper.advanceTime(100); // NPCåˆ†æå¤±è´¥åŸå› 
    npc.attemptTask(new ComplexTask());
    helper.assertTaskResult(TaskResult.SUCCESS);
}
```

---

### 2.2 æ€§èƒ½æµ‹è¯•éœ€æ±‚

#### éœ€æ±‚ P1: å¤§è§„æ¨¡NPCæ€§èƒ½æµ‹è¯•
**ä¼˜å…ˆçº§**: ğŸ”´ é«˜  
**é¢„è®¡éœ€è¦æ—¶é—´**: 1-2ä¸ªæœˆ

**åœºæ™¯æè¿°**ï¼š
æµ‹è¯•æœåŠ¡å™¨åœ¨å¤§é‡NPCæ—¶çš„æ€§èƒ½ï¼š
- 100ä¸ªNPCåŒæ—¶è¿è¡Œ
- æ¯ä¸ªNPCæœ‰ç‹¬ç«‹çš„æ€ç»´ç³»ç»Ÿ
- æµ‹é‡TPSä¸‹é™

**æœŸæœ›çš„æµ‹è¯•API**ï¼š
```java
@PerformanceTest
void testLargeScale(PerformanceTestHelper helper) {
    List<NPC> npcs = helper.spawnNPCs(count: 100);
    
    helper.runFor(duration: 1000 ticks);
    
    PerformanceReport report = helper.getReport();
    helper.assertTPS(report, minTPS: 18); // ä¸ä½äº18 TPS
    helper.assertAvgTickTime(report, maxMs: 40); // ä¸è¶…è¿‡40ms
}
```

**å®ç°å»ºè®®**ï¼š
- ä¸“ç”¨çš„æ€§èƒ½æµ‹è¯•æ¡†æ¶
- è‡ªåŠ¨TPSç›‘æ§
- æ€§èƒ½å›å½’æ£€æµ‹

---

#### éœ€æ±‚ P2: å†…å­˜æ³„æ¼æ£€æµ‹
**ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­  
**é¢„è®¡éœ€è¦æ—¶é—´**: 1ä¸ªæœˆ

**åœºæ™¯æè¿°**ï¼š
é•¿æ—¶é—´è¿è¡Œæµ‹è¯•ï¼Œæ£€æµ‹å†…å­˜æ˜¯å¦æŒç»­å¢é•¿ï¼š
- NPCç”Ÿæˆå¹¶é”€æ¯1000æ¬¡
- è®°å¿†ç³»ç»Ÿæ˜¯å¦æ­£ç¡®æ¸…ç†
- Listeneræ˜¯å¦æ­£ç¡®æ³¨é”€

**æœŸæœ›çš„æµ‹è¯•API**ï¼š
```java
@MemoryTest
void testMemoryLeak(MemoryTestHelper helper) {
    long initialMemory = helper.getUsedMemory();
    
    for (int i = 0; i < 1000; i++) {
        NPC npc = helper.spawnNPC(...);
        helper.advanceTicks(100);
        npc.remove();
    }
    
    helper.forceGC();
    long finalMemory = helper.getUsedMemory();
    
    helper.assertMemoryGrowth(finalMemory - initialMemory, maxMB: 10);
}
```

---

### 2.3 è°ƒè¯•ä¸å¯è§†åŒ–éœ€æ±‚

#### éœ€æ±‚ D1: å¯è§†åŒ–æµ‹è¯•è¿è¡Œ
**ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­  
**é¢„è®¡éœ€è¦æ—¶é—´**: 2-3ä¸ªæœˆ

**åœºæ™¯æè¿°**ï¼š
ç”Ÿæˆæµ‹è¯•è¿è¡Œçš„å¯è§†åŒ–æŠ¥å‘Šï¼š
- NPCçš„ç§»åŠ¨è½¨è¿¹
- ç›®æ ‡åˆ‡æ¢æ—¶é—´çº¿
- è®°å¿†çŠ¶æ€å˜åŒ–

**æœŸæœ›è¾“å‡º**ï¼š
- HTMLæŠ¥å‘Šï¼ŒåŒ…å«äº¤äº’å¼å›¾è¡¨
- æ—¶é—´è½´è§†å›¾
- 3Dä¸–ç•Œå›æ”¾

**å®ç°å»ºè®®**ï¼š
- é›†æˆæ•°æ®å¯è§†åŒ–åº“ï¼ˆå¦‚D3.jsï¼‰
- è®°å½•æµ‹è¯•è¿‡ç¨‹çš„å…³é”®å¸§
- Webç•Œé¢å±•ç¤º

---

#### éœ€æ±‚ D2: äº¤äº’å¼è°ƒè¯•å™¨
**ä¼˜å…ˆçº§**: ğŸŸ¢ ä½  
**é¢„è®¡éœ€è¦æ—¶é—´**: 3-6ä¸ªæœˆ

**åœºæ™¯æè¿°**ï¼š
åœ¨æµ‹è¯•å¤±è´¥æ—¶ï¼Œæä¾›äº¤äº’å¼è°ƒè¯•ï¼š
- æš‚åœæµ‹è¯•
- æ£€æŸ¥NPCçŠ¶æ€
- å•æ­¥æ‰§è¡Œtick
- ä¿®æ”¹å˜é‡å¹¶ç»§ç»­

**æœŸæœ›å·¥å…·**ï¼š
```
Test Debugger UI:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Test: testTheGatherer (FAILED)     â”‚
â”‚ Tick: 47 / 100                      â”‚
â”‚                                     â”‚
â”‚ NPC State:                          â”‚
â”‚   Current Goal: GatherItemGoal      â”‚
â”‚   Action Queue: [MoveToItem]        â”‚
â”‚   Memory: 5 entries                 â”‚
â”‚                                     â”‚
â”‚ [Step] [Continue] [Inspect] [Fail] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ› ï¸ ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ¨èçš„è§£å†³æ–¹æ¡ˆ

### 3.1 çŸ­æœŸæ–¹æ¡ˆï¼ˆ1-2å‘¨ï¼‰

#### æ–¹æ¡ˆ S1: ä¿®å¤ç°æœ‰GameTesté—®é¢˜
**ç›®æ ‡**: è®©å½“å‰3ä¸ªå¤±è´¥çš„æµ‹è¯•é€šè¿‡

**æ­¥éª¤**ï¼š
1. ç§»é™¤`succeedOnTickWhen()`ï¼Œç»Ÿä¸€ä½¿ç”¨`succeedWhen()`
2. æ˜¾å¼åˆ›å»ºå¹¶é™„åŠ `NpcMind` attachment
3. æ‰‹åŠ¨å®ç°tickè®¡æ•°å™¨

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ‰€æœ‰33ä¸ªæµ‹è¯•é€šè¿‡
- âœ… å»ºç«‹å¯é çš„æµ‹è¯•åŸºçº¿

---

#### æ–¹æ¡ˆ S2: åˆ›å»ºæµ‹è¯•å·¥å…·ç±»
**ç›®æ ‡**: ç®€åŒ–æµ‹è¯•ç¼–å†™

**å®ç°**ï¼š
```java
public class NpcTestHelper {
    public static NPC spawnNPCWithMind(GameTestHelper helper, BlockPos pos) {
        Zombie zombie = helper.spawn(EntityType.ZOMBIE, pos);
        NpcMind mind = new NpcMind();
        zombie.setData(NpcMindAttachment.NPC_MIND, mind);
        mind.getSensorManager().registerSensor(new VisionSensor());
        return zombie;
    }
    
    public static void waitForCondition(
        GameTestHelper helper, 
        BooleanSupplier condition,
        int maxTicks
    ) {
        // å®ç°æ¡ä»¶ç­‰å¾…é€»è¾‘
    }
}
```

---

### 3.2 ä¸­æœŸæ–¹æ¡ˆï¼ˆ1-3ä¸ªæœˆï¼‰

#### æ–¹æ¡ˆ M1: è‡ªå®šä¹‰æµ‹è¯•æ¡†æ¶
**ç›®æ ‡**: å…‹æœGameTestçš„å±€é™æ€§

**æ¶æ„è®¾è®¡**ï¼š
```
CustomNPCTestFramework/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ TestRunner.java          - æµ‹è¯•æ‰§è¡Œå™¨
â”‚   â”œâ”€â”€ TestContext.java         - æµ‹è¯•ä¸Šä¸‹æ–‡
â”‚   â””â”€â”€ TestLifecycle.java       - ç”Ÿå‘½å‘¨æœŸç®¡ç†
â”œâ”€â”€ assertions/
â”‚   â”œâ”€â”€ NPCAssertions.java       - NPCçŠ¶æ€æ–­è¨€
â”‚   â”œâ”€â”€ GoalAssertions.java      - ç›®æ ‡æ–­è¨€
â”‚   â””â”€â”€ MemoryAssertions.java    - è®°å¿†æ–­è¨€
â”œâ”€â”€ helpers/
â”‚   â”œâ”€â”€ AsyncTestHelper.java    - å¼‚æ­¥æµ‹è¯•æ”¯æŒ
â”‚   â”œâ”€â”€ EnvironmentBuilder.java - ç¯å¢ƒæ„å»ºå™¨
â”‚   â””â”€â”€ NPCFactory.java          - NPCå·¥å‚
â””â”€â”€ reporting/
    â”œâ”€â”€ TestReport.java          - æµ‹è¯•æŠ¥å‘Š
    â””â”€â”€ HTMLReporter.java        - HTMLæŠ¥å‘Šç”Ÿæˆ
```

**ç¤ºä¾‹ä½¿ç”¨**ï¼š
```java
@CustomNPCTest
public class GathererTest extends NPCTestBase {
    
    @Test
    void shouldGatherItem() {
        // ä½¿ç”¨è‡ªå®šä¹‰æ¡†æ¶
        Environment env = environment()
            .withNPC(npc -> npc
                .at(2, 2, 2)
                .withGoal(new GatherItemGoal(...))
            )
            .withItem(Items.STICK, at(12, 2, 2));
        
        env.runUntil(
            condition: npc -> npc.hasItemInHand(Items.STICK),
            timeout: 100
        );
        
        assertThat(env.getNPC())
            .hasItemInMainHand(Items.STICK)
            .hasCompletedGoal(GatherItemGoal.class);
    }
}
```

---

#### æ–¹æ¡ˆ M2: é›†æˆæ€§èƒ½ç›‘æ§
**ç›®æ ‡**: è‡ªåŠ¨åŒ–æ€§èƒ½å›å½’æ£€æµ‹

**å®ç°**ï¼š
```java
@PerformanceTest
public class PerformanceTests {
    
    @Benchmark(maxMs = 50)
    void benchmarkGoapPlanning() {
        // è‡ªåŠ¨æµ‹é‡è§„åˆ’æ—¶é—´
        // å¦‚æœè¶…è¿‡50msï¼Œæµ‹è¯•å¤±è´¥
    }
    
    @ProfiledTest
    void profileSensorTick() {
        // è‡ªåŠ¨profileå¹¶ç”ŸæˆæŠ¥å‘Š
    }
}
```

---

### 3.3 é•¿æœŸæ–¹æ¡ˆï¼ˆ3-6ä¸ªæœˆï¼‰

#### æ–¹æ¡ˆ L1: å®Œæ•´çš„æµ‹è¯•ç”Ÿæ€ç³»ç»Ÿ
**ç›®æ ‡**: ä¼ä¸šçº§æµ‹è¯•èƒ½åŠ›

**ç»„ä»¶**ï¼š
1. **æµ‹è¯•æ¡†æ¶** - è‡ªå®šä¹‰DSLï¼Œæ”¯æŒå¤æ‚åœºæ™¯
2. **æ€§èƒ½ç›‘æ§** - æŒç»­æ€§èƒ½è¿½è¸ªå’Œå›å½’æ£€æµ‹
3. **å¯è§†åŒ–å·¥å…·** - Webç•Œé¢æŸ¥çœ‹æµ‹è¯•ç»“æœ
4. **CI/CDé›†æˆ** - è‡ªåŠ¨åŒ–æµ‹è¯•å’ŒæŠ¥å‘Š
5. **æµ‹è¯•æ•°æ®ç®¡ç†** - ç‰ˆæœ¬æ§åˆ¶çš„æµ‹è¯•åœºæ™¯

**æŠ€æœ¯æ ˆ**ï¼š
- æµ‹è¯•æ¡†æ¶ï¼šJUnit 5 + è‡ªå®šä¹‰æ‰©å±•
- æ€§èƒ½ç›‘æ§ï¼šJMH (Java Microbenchmark Harness)
- å¯è§†åŒ–ï¼šSpring Boot + React
- æŠ¥å‘Šï¼šAllure Test Report

---

## ğŸ“Š ç¬¬å››éƒ¨åˆ†ï¼šä¼˜å…ˆçº§çŸ©é˜µ

| é—®é¢˜/éœ€æ±‚ | ä¸¥é‡ç¨‹åº¦ | å®ç°éš¾åº¦ | é¢„æœŸæ”¶ç›Š | æ¨èä¼˜å…ˆçº§ |
|----------|---------|---------|---------|-----------|
| A1: Final Clauseå†²çª | ğŸ”´ é«˜ | ğŸŸ¢ ä½ | ğŸ”´ é«˜ | **P0 - ç«‹å³** |
| A2: Tickæ—¶åºæ§åˆ¶ | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­ | **P1 - æœ¬å‘¨** |
| A3: Attachmentåˆå§‹åŒ– | ğŸŸ¡ ä¸­ | ğŸŸ¢ ä½ | ğŸŸ¡ ä¸­ | **P1 - æœ¬å‘¨** |
| B1: å¼‚æ­¥ä»»åŠ¡æµ‹è¯• | ğŸ”´ é«˜ | ğŸ”´ é«˜ | ğŸ”´ é«˜ | **P1 - 1ä¸ªæœˆ** |
| B2: è¡Œä¸ºå¯å¤ç°æ€§ | ğŸ”´ é«˜ | ğŸŸ¡ ä¸­ | ğŸ”´ é«˜ | **P1 - 1ä¸ªæœˆ** |
| B3: æ€§èƒ½ç›‘æ§ | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­ | **P2 - 2ä¸ªæœˆ** |
| B4: å†³ç­–å¯è§‚æµ‹æ€§ | ğŸŸ¡ ä¸­ | ğŸ”´ é«˜ | ğŸŸ¡ ä¸­ | **P2 - 2ä¸ªæœˆ** |
| C1: ç»“æ„æ–‡ä»¶ç®¡ç† | ğŸŸ¡ ä¸­ | ğŸŸ¢ ä½ | ğŸŸ¢ ä½ | **P2 - 2ä¸ªæœˆ** |
| C2: æµ‹è¯•æ•°æ®éš”ç¦» | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­ | **P3 - 3ä¸ªæœˆ** |
| F1: å¤šNPCåä½œ | ğŸ”´ é«˜ | ğŸ”´ é«˜ | ğŸ”´ é«˜ | **P2 - 3ä¸ªæœˆ** |
| F2: åŠ¨æ€ç¯å¢ƒå˜åŒ– | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­ | ğŸŸ¡ ä¸­ | **P3 - 4ä¸ªæœˆ** |
| P1: å¤§è§„æ¨¡æ€§èƒ½æµ‹è¯• | ğŸ”´ é«˜ | ğŸŸ¡ ä¸­ | ğŸ”´ é«˜ | **P1 - 2ä¸ªæœˆ** |

---

## ğŸ¯ ç¬¬äº”éƒ¨åˆ†ï¼šè¡ŒåŠ¨è®¡åˆ’

### Phase 1: ç¨³å®šç°æœ‰æµ‹è¯•ï¼ˆ1-2å‘¨ï¼‰
- [ ] ä¿®å¤3ä¸ªå¤±è´¥çš„GameTest
- [ ] åˆ›å»º`NpcTestHelper`å·¥å…·ç±»
- [ ] ç¼–å†™æµ‹è¯•æœ€ä½³å®è·µæ–‡æ¡£

### Phase 2: å¢å¼ºæµ‹è¯•èƒ½åŠ›ï¼ˆ1-2ä¸ªæœˆï¼‰
- [ ] å®ç°å¼‚æ­¥æµ‹è¯•æ”¯æŒ
- [ ] æ·»åŠ è¡Œä¸ºå¯å¤ç°æ€§ä¿è¯ï¼ˆéšæœºç§å­æ§åˆ¶ï¼‰
- [ ] é›†æˆåŸºç¡€æ€§èƒ½ç›‘æ§

### Phase 3: æ„å»ºæµ‹è¯•æ¡†æ¶ï¼ˆ2-3ä¸ªæœˆï¼‰
- [ ] è®¾è®¡å¹¶å®ç°è‡ªå®šä¹‰æµ‹è¯•æ¡†æ¶
- [ ] è¿ç§»ç°æœ‰æµ‹è¯•åˆ°æ–°æ¡†æ¶
- [ ] æ·»åŠ å¯è§†åŒ–æŠ¥å‘Šç”Ÿæˆ

### Phase 4: é«˜çº§åŠŸèƒ½ï¼ˆ3-6ä¸ªæœˆï¼‰
- [ ] å¤šNPCåä½œæµ‹è¯•
- [ ] å†³ç­–è¿‡ç¨‹è¿½è¸ª
- [ ] CI/CDé›†æˆ

---

## ğŸ“– é™„å½•

### A. å‚è€ƒèµ„æ–™
- [Minecraft GameTest å®˜æ–¹æ–‡æ¡£](https://minecraft.wiki/w/Game_Test)
- [JUnit 5 æœ€ä½³å®è·µ](https://junit.org/junit5/docs/current/user-guide/)
- [JMHæ€§èƒ½æµ‹è¯•](https://github.com/openjdk/jmh)

### B. ç›¸å…³æ–‡ä»¶
- å½“å‰æµ‹è¯•å®ç°ï¼š[`ComplexScenarios.java`](file:///home/kiz/Code/java/Guzhenren-ext/src/main/java/com/Kizunad/customNPCs_test/tests/ComplexScenarios.java)
- GameTestæŒ‡å—ï¼š[`NO_GUI_Testing.md`](file:///home/kiz/Code/java/Guzhenren-ext/docs/Testing/NO_GUI_Testing.md)

### C. è´¡çŒ®è€…
- åˆå§‹åˆ†æï¼šAI Assistant
- æŠ€æœ¯å®¡æ ¸ï¼šå¾…å®š

---

**æ–‡æ¡£ç»“æŸ**
